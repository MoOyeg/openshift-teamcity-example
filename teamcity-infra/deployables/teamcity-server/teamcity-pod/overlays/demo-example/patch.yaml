apiVersion: apps/v1
kind: Deployment
metadata:
  name: teamcity-server-instance
  namespace: teamcity-server
spec:
  selector:
    matchLabels:
      app: teamcity-server-instance
  replicas: 1
  template:
    metadata:
      labels:
        app: teamcity-server-instance
    spec:
      serviceAccountName: teamcity-sa
      volumes:
        - name: teamcity-data
          persistentVolumeClaim:
            claimName: teamcity-data-pvc
        - name: teamcity-log
          persistentVolumeClaim:
            claimName: teamcity-log-pvc
        - name: ca-configmap
          configMap:
            name: ca-configmap
            defaultMode: 420         
      initContainers:
      - name: init-restore
        image: registry.redhat.io/ubi8/ubi:8.5-226.1645809065
        env:
          - name: TIDB_HOST
            value: basic-tidb
          - name: TIDB_PORT
            value: '4000'
          - name: SLEEP
            value: '5'
          - name: BACKUP_ZIP_URL
            value: https://github.com/MoOyeg/openshift-teamcity-example/raw/main/teamcity-infra/deployables/teamcity-server/teamcity-pod/overlays/demo-example/teamcity-backup.zip
        volumeMounts:
          - mountPath: "/data/teamcity_server/datadir"
            name: teamcity-data
        command: 
          - /bin/bash
          - -c
          - |
            #Extract OC
            mkdir /tmp/cli       
            curl -o /tmp/cli/oc.tar -L -O https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.8.0/openshift-client-linux.tar.gz && tar -xvf /tmp/cli/oc.tar -C /tmp/cli
            echo ""
            
            #Install Unzip
            yum install unzip -y

            echo -n "Waiting for Teamcity Route to be Ready"
            until [[ -n $(/tmp/cli/oc get route/teamcity-server-instance -o jsonpath='{.spec.host}') ]];do echo "Route is not available" && sleep $SLEEP;done
            route=$(/tmp/cli/oc get route/teamcity-server-instance -o jsonpath='{.spec.host}')
            curl -o /data/teamcity_server/datadir/teamcity-backup.zip -L -O https://github.com/MoOyeg/openshift-teamcity-example/raw/main/teamcity-infra/deployables/teamcity-server/teamcity-pod/overlays/demo-example/teamcity-backup.zip
            cd /data/teamcity_server/datadir/ && unzip teamcity-backup.zip
            ls .

                        